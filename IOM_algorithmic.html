<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Four Experiment</title>
    
    <!-- Load jsPsych -->
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.2"></script>
    
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />

    <style>

        html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        input[type="checkbox"], 
        input[type="radio"] {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .s2handle {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
            -webkit-appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }

        .progress-container {
            width: 200px;
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            padding: 5px;
            text-align: center;
        }

        .progress-bar {
            height: 10px;
            background-color: #808080;
            border-radius: 8px;
            transition: width 0.3s ease;
        }

        .progress-label {
            margin-bottom: 5px;
            font-size: 16px;
            color: #333;
        }

        .instruction-progress {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
        }

        .instruction-image {
            max-width: 85%;
            height: auto;
            margin: 10px auto;
            display: block;
        }

        .jspsych-instructions-nav {
            position: relative;
            top: -50px; /* Adjust this value to move buttons higher */
        }
        
        .jspsych-btn {
            padding: 25px 50px;
            font-size: 24px;
            min-width: 200px;       
            min-height: 80px; 
            margin: 10px;
            cursor: pointer;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(7, 80px);
            gap: 5px;
            padding: 10px;
            background-color: blue;
            border-radius: 10px;
            margin: 0 auto;
        }
        .cell {
            width: 80px;
            height: 80px;
            background-color: white;
            border-radius: 50%;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        .cell.empty:hover {
            background-color: #eee;
        }
        .red {
            background-color: red;
        }
        .yellow {
            background-color: yellow;
        }
        .game-button {
            padding: 25px 50px;
            font-size: 24px;
            min-width: 200px;
            min-height: 80px;
            cursor: pointer;
        }
        .submit-button {
            background-color: #4CAF50;
            color: white;
            border: none;
        }
        .submit-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .undo-button {
            background-color: #FFA500;
            color: white;
            border: none;
        }
        .undo-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .jspsych-html-slider-response-container {
            width: 800px !important;
            margin: 100px auto;
            position: relative;
        }
        .jspsych-slider {
        appearance: none;
        -webkit-appearance: none;
        width: 800px !important;
        height: 20px;
        background: #ddd;
        border-radius: 10px;
        margin: 30px 0 40px 0;
        padding: 0;

        }
        .jspsych-slider::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            background: #0000FF;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .jspsych-slider.clicked::-webkit-slider-thumb {
            opacity: 1;
        }
        .cell.highlighted {
            box-shadow: 0 0 15px 5px #FFD700;
            border: 3px solid #FFD700;
        }
        .cell {
            transition: all 0.3s ease;
        }

    </style>
</head>
<body>
    <form id="socisurvey_form" method="post" action="https://www.soscisurvey.de/metacognition2025/" target="_parent">
        <input type="hidden" name="return" value="6">
        <input type="hidden" name="q_complete" value="1">
        <input type="hidden" name="condition" value="control">
        <div id="dynamic-fields"></div>
    </form>
    
    <script>
         function validateSociSurveyForm() {
        const form = document.getElementById('socisurvey_form');
        if (!form) {
            console.warn('Form not found during validation');
            return false;
        }

        // Check essential fields
        const essentialFields = ['return', 'q_complete', 'condition'];
        const missingFields = essentialFields.filter(field => {
            const input = form.querySelector(`input[name="${field}"]`);
            return !input || !input.value;
        });

        if (missingFields.length > 0) {
            console.warn('Missing essential fields:', missingFields);
            return false;
        }

        return true;
    }

    // Define experiment variables
    const experimentCondition = 'algorithmic';
    
    // Initialize counters
    window.expectationCount = 0;
    window.performanceCount = 0;
    window.adviceCount = 0;

    document.addEventListener('DOMContentLoaded', function() {
        try {
            const form = document.getElementById('socisurvey_form');
            const dynamicFields = document.getElementById('dynamic-fields');
            
            if (!form || !dynamicFields) {
                throw new Error('Required elements not found');
            }

            // Set form properties
            form.method = 'POST';
            form.enctype = 'application/x-www-form-urlencoded';

            // Create and append all required fields
            function createHiddenField(name, value = '0') {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.id = name;
                input.name = name;
                input.value = value;
                dynamicFields.appendChild(input);
                console.log(`Created field: ${name}`);
            }

            // Create ED01-ED07 fields (32 trials each)
            for (let i = 1; i <= 32; i++) {
                const trialNum = String(i).padStart(2, '0');
                ['ED01', 'ED02', 'ED03', 'ED04', 'ED05', 'ED06', 'ED07'].forEach(prefix => {
                    createHiddenField(`${prefix}_${trialNum}`);
                });
            }

            // Create ED08-ED09 fields (6 each)
            for (let i = 1; i <= 6; i++) {
                const num = String(i).padStart(2, '0');
                ['ED08', 'ED09'].forEach(prefix => {
                    createHiddenField(`${prefix}_${num}`);
                });
            }

            // Create ED10 fields (3)
            for (let i = 1; i <= 3; i++) {
                createHiddenField(`ED10_${String(i).padStart(2, '0')}`);
            }

            // Create single instance fields
            ['ED11', 'ED12', 'ED13', 'ED14', 'ED15', 'ED16', 'ED17'].forEach(prefix => {
                createHiddenField(`${prefix}_01`);
            });

            // Set form action
            form.action = `https://www.soscisurvey.de/metacognition2025/?condition=${experimentCondition}&return=6&q_complete=1`;
            
            console.log('Form initialization complete');
            
            // Verify fields were created
            const inputs = form.getElementsByTagName('input');
            console.log(`Created ${inputs.length} form fields`);
            
        } catch (error) {
            console.error('Error during form initialization:', error);
        }
    });
// Initialize jsPsych
const jsPsych = initJsPsych();

// Store experiment start time
const experimentStartTime = Date.now();

// SociSurvey Integration
const SociSurveyIntegration = {
    prepareData(jsPsych) {
        try {
            console.log('Starting data preparation...');
            const form = document.getElementById('socisurvey_form');
            if (!form) {
                console.error('Form not found!');
                return false;
            }

            // First, ensure all form fields exist
            this.createFormFields(form);

            // Get trial and rating data
            const trials = jsPsych.data.get().filter(trial => 
                trial.trial_type === 'board-trial'
            ).values();
            console.log('Found trials:', trials.length);

            const ratings = jsPsych.data.get().filter(trial => 
                trial.rating_type !== undefined
            ).values();
            console.log('Found ratings:', ratings.length);

            // Enhanced setFieldValue function
            const setFieldValue = (id, value) => {
                let element = document.getElementById(id);
                if (!element) {
                    // Create field if it doesn't exist
                    element = document.createElement('input');
                    element.type = 'hidden';
                    element.id = id;
                    element.name = id;
                    form.appendChild(element);
                    console.log(`Created missing field: ${id}`);
                }
                element.value = value;
                console.log(`Set ${id} to ${value}`);
            };

            // Process trials
            trials.forEach(trial => {
                const trialNumber = String(trial.trial_number).padStart(2, '0');
                if (!trialNumber) {
                    console.error('Trial missing trial number:', trial);
                    return;
                }
                
                setFieldValue(`ED01_${trialNumber}`, trial.total_duration || 0);
                setFieldValue(`ED02_${trialNumber}`, trial.total_changes || 0);
                setFieldValue(`ED03_${trialNumber}`, trial.choice_col ?? -1);
                setFieldValue(`ED04_${trialNumber}`, trial.response_times ? 
                    trial.response_times[trial.response_times.length - 1] || 0 : 0);
                setFieldValue(`ED05_${trialNumber}`, trial.confidence_rating || 0);
                setFieldValue(`ED07_${trialNumber}`, trial.inactivity_warnings || 0);

                // Keep your existing move ratings handling
                if (typeof window.moveRatings !== 'undefined' && 
                    window.moveRatings[trial.trial_number - 1] && 
                    typeof trial.choice_row !== 'undefined' && 
                    typeof trial.choice_col !== 'undefined') {
                    try {
                        setFieldValue(`ED06_${trialNumber}`, 
                            window.moveRatings[trial.trial_number - 1].ratings[trial.choice_row][trial.choice_col]);
                    } catch (e) {
                        console.warn('Could not access move rating:', e);
                        setFieldValue(`ED06_${trialNumber}`, 0);
                    }
                }
            });

            // Handle ratings data
            ratings.forEach(rating => {
                let elementId;
                switch(rating.rating_type) {
                    case 'expectation':
                        elementId = `ED08_${String(window.expectationCount || 0).padStart(2, '0')}`;
                        window.expectationCount = (window.expectationCount || 0) + 1;
                        break;
                    case 'performance':
                        elementId = `ED09_${String(window.performanceCount || 0).padStart(2, '0')}`;
                        window.performanceCount = (window.performanceCount || 0) + 1;
                        break;
                    case 'advice_quality':
                        elementId = `ED10_${String(window.adviceCount || 0).padStart(2, '0')}`;
                        window.adviceCount = (window.adviceCount || 0) + 1;
                        break;
                }

                if (elementId) {
                    setFieldValue(elementId, rating.response || 0);
                }
            });

            // Other data fields
            setFieldValue('ED11_01', experimentCondition || '');
            setFieldValue('ED12_01', Date.now() - experimentStartTime);
            setFieldValue('ED14_01', JSON.stringify({
                userAgent: navigator.userAgent,
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                windowSize: `${window.innerWidth}x${window.innerHeight}`
            }));

            // Handle manipulation check
            const manipCheck = jsPsych.data.get().filter(trial => 
                trial.task === 'manipulation_check'
            ).values()[0];
            if (manipCheck) {
                setFieldValue('ED13_01', manipCheck.is_correct ? 1 : 0);
            }

            console.log('Data preparation completed successfully');
            return true;

        } catch (error) {
            console.error('Error preparing data:', error);
            return false;
        }
    },

    // Add this new method to create form fields
    createFormFields(form) {
        // Create trial-specific fields (ED01-ED07)
        for (let trial = 1; trial <= 32; trial++) {
            const trialNum = String(trial).padStart(2, '0');
            ['ED01', 'ED02', 'ED03', 'ED04', 'ED05', 'ED06', 'ED07'].forEach(prefix => {
                const id = `${prefix}_${trialNum}`;
                if (!document.getElementById(id)) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.id = id;
                    input.name = id;
                    form.appendChild(input);
                }
            });
        }

        // Create single-value fields (ED08-ED17)
        ['ED11_01', 'ED12_01', 'ED13_01', 'ED14_01', 'ED15_01', 'ED16_01', 'ED17_01'].forEach(id => {
            if (!document.getElementById(id)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.id = id;
                input.name = id;
                form.appendChild(input);
            }
        });
    },

    submit() {
        try {
            const form = document.getElementById('socisurvey_form');
            if (!form) {
                console.error('Form not found during submission');
                return false;
            }

            // Log all form values before submission
            const formData = new FormData(form);
            for (let [name, value] of formData.entries()) {
                console.log(`Submitting ${name}: ${value}`);
            }

            form.submit();
            return true;
        } catch (error) {
            console.error('Form submission error:', error);
            return false;
        }
    }
};
    console.log('Condition from URL:', experimentCondition);
        const DataCollector = {
            experimentStart: null,
            experimentData: {
                condition: null,
                total_duration: 0,
                instruction_duration: 0,
                practice_duration: 0,
                experimental_duration: 0,
                timeline_segments: [],
                ratings: [],
                manipulation_check: null,
                board_trials: []
            }, 
            
            initializeExperiment() {
                this.experimentStart = Date.now();
                this.experimentData.condition = experimentCondition;
            },

            recordTimelineSegment(segmentName, duration) {
                this.experimentData.timeline_segments.push({
                    name: segmentName,
                    duration: duration,
                    timestamp: Date.now()
                });
            },

            recordBoardTrial(trialData) {
                try {
                    this.experimentData.board_trials.push({
                        trial_number: trialData.trial_number,
                        time_start: trialData.trial_start,
                        time_end: Date.now(),
                        total_duration: Date.now() - trialData.trial_start,
                        move_history: trialData.move_changes,
                        total_moves: trialData.total_changes,
                        final_move: {
                            row: trialData.choice_row,
                            col: trialData.choice_col
                        },
                        confidence_rating: trialData.confidence_rating,
                        inactivity_warnings: trialData.inactivity_warnings,
                        feedback_rating: trialData.feedback_rating
                    });
                } catch (error) {
                    console.error('Error recording trial data:', error);
                }
            },

            recordRating(type, value, responseTime, adjustments) {
                this.experimentData.ratings.push({
                    type: type,
                    value: value,
                    response_time: responseTime,
                    adjustments: adjustments,
                    timestamp: Date.now()
                });
            },

            recordManipulationCheck(data) {
                this.experimentData.manipulation_check = {
                    response: data.response,
                    is_correct: data.is_correct,
                    response_time: data.rt,
                    choice_made: data.choice_made
                };
            },

            getFinalData() {
                return {
                ...this.experimentData,
                total_duration: Date.now() - this.experimentStart,
                completion_time: new Date().toISOString(),
                browser_info: {
                    userAgent: navigator.userAgent,
                    screen_resolution: `${window.screen.width}x${window.screen.height}`,
                    window_size: `${window.innerWidth}x${window.innerHeight}`
                }
            };
        }
    };

    window.onerror = function(message, source, lineno, colno, error) {
        console.error('Global error:', {message, source, lineno, colno, error});
        return false;
    };

    DataCollector.initializeExperiment();

        // Board states
        const boardStates = [

        // practice trials 
            [[0, 0, 2, 1, 1, 0, 0],[0, 0, 2, 1, 1, 0, 0],[0, 0, 2, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state practice 1
            [[0, 0, 1, 2, 1, 0, 0],[0, 0, 0, 2, 1, 0, 0],[0, 0, 0, 2, 1, 0, 0],[0, 0, 0, 1, 2, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state practice 2    // --> Prospective performance rating

        // experimental trials
            [[0, 1, 2, 1, 2, 1, 2],[0, 1, 0, 0, 0, 2, 1],[0, 0, 0, 0, 0, 1, 0],[0, 0, 0, 0, 0, 2, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 3
            [[2, 1, 2, 1, 0, 1, 2],[1, 0, 2, 0, 0, 1, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 4 
            [[2, 0, 0, 1, 2, 0, 1],[1, 0, 0, 2, 0, 0, 2],[1, 0, 0, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 5
            [[2, 2, 1, 2, 1, 2, 1],[2, 0, 1, 2, 0, 1, 1],[1, 0, 0, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 2],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 6
            [[2, 2, 1, 2, 0, 1, 1],[1, 1, 2, 0, 0, 1, 2],[0, 0, 2, 0, 0, 0, 2],[0, 0, 1, 0, 0, 0, 0],[0, 0, 1, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 7
            [[1, 2, 0, 2, 1, 1, 1],[2, 2, 0, 0, 2, 0, 0],[0, 1, 0, 0, 0, 0, 0],[0, 1, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 8
            [[0, 0, 0, 1, 2, 1, 1],[0, 0, 0, 2, 2, 0, 1],[0, 0, 0, 0, 1, 0, 0],[0, 0, 0, 0, 2, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 9
            [[1, 2, 1, 0, 1, 2, 0],[2, 0, 2, 0, 1, 0, 0],[1, 0, 1, 0, 0, 0, 0],[0, 0, 2, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 10
            [[2, 1, 1, 1, 2, 2, 2],[2, 1, 1, 0, 2, 1, 1],[1, 2, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 11
            [[0, 2, 1, 1, 1, 2, 0],[0, 1, 2, 2, 1, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 12
            [[1, 2, 0, 2, 0, 1, 1],[0, 0, 0, 1, 0, 2, 2],[0, 0, 0, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 2],[0, 0, 0, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 0]],   // Board state 13
            [[2, 1, 1, 1, 2, 0, 0],[2, 0, 2, 1, 1, 0, 0],[0, 0, 1, 2, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 14
            [[1, 1, 1, 2, 1, 2, 2],[0, 0, 0, 2, 1, 0, 2],[0, 0, 0, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 15
            [[1, 1, 2, 2, 1, 2, 2],[1, 0, 2, 1, 1, 1, 2],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 16
            [[2, 2, 1, 1, 2, 1, 1],[0, 1, 1, 2, 2, 2, 1],[0, 0, 0, 0, 2, 0, 0],[0, 0, 0, 0, 1, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 17
            [[2, 1, 1, 2, 1, 0, 1],[2, 0, 2, 0, 1, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 18
            [[1, 2, 0, 2, 1, 0, 0],[1, 1, 0, 0, 0, 0, 0],[0, 2, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 19
            [[2, 1, 1, 2, 1, 0, 1],[0, 2, 0, 0, 2, 0, 2],[0, 1, 0, 0, 1, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 20
            [[0, 2, 1, 2, 1, 1, 0],[0, 1, 0, 2, 2, 1, 0],[0, 2, 0, 0, 0, 0, 0],[0, 1, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 21
            [[1, 2, 1, 0, 2, 0, 0],[1, 2, 2, 0, 0, 0, 0],[1, 1, 0, 0, 0, 0, 0],[2, 1, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 22           //--> Prospective performance rating --> Retrospective performance rating
            [[2, 2, 1, 1, 2, 2, 1],[1, 2, 0, 0, 0, 0, 1],[0, 1, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 23
            [[0, 2, 1, 1, 1, 2, 0],[0, 0, 1, 2, 0, 0, 0],[0, 0, 0, 2, 0, 0, 0],[0, 0, 0, 1, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 24
            [[1, 0, 1, 2, 1, 0, 1],[2, 0, 0, 2, 1, 0, 2],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 25
            [[1, 2, 0, 2, 1, 2, 1],[2, 1, 0, 2, 1, 0, 1],[1, 0, 0, 0, 0, 0, 2],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 26
            [[2, 1, 2, 0, 2, 1, 1],[1, 2, 0, 0, 1, 2, 1],[1, 0, 0, 0, 2, 0, 0],[2, 0, 0, 0, 0, 0, 0],[1, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 27
            [[2, 1, 1, 2, 1, 0, 0],[0, 1, 2, 1, 1, 0, 0],[0, 1, 2, 2, 0, 0, 0],[0, 2, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 28
            [[2, 0, 1, 1, 0, 2, 1],[1, 0, 2, 0, 0, 0, 1],[2, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 29
            [[1, 2, 2, 2, 1, 0, 1],[1, 1, 1, 2, 2, 0, 1],[2, 0, 0, 0, 1, 0, 2],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 30 
            [[2, 1, 1, 2, 0, 2, 1],[1, 2, 2, 0, 0, 1, 2],[2, 0, 1, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 31 
            [[2, 1, 1, 2, 2, 1, 2],[1, 0, 0, 0, 1, 2, 2],[0, 0, 0, 0, 1, 0, 1],[0, 0, 0, 0, 2, 0, 1],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],   // Board state 32           //--> Retrospective performance rating


        ];

        console.log('Board states defined:', boardStates.length, 'states');

        // Move ratings
        const moveRatings = [

            // practice trials
            { // Ratings for board state practice 1
                board: [[0, 0, 2, 1, 1, 0, 0],[0, 0, 2, 1, 1, 0, 0],[0, 0, 2, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                   [-3, -3, 3, -3, -3, -3, -3],    
                   [-3, -3, 3, -3, -3, -3, -3],    
                   [-3, -3, 3, -3, -3, -3, -3],    
                   [-3, -3, 3, -3, -3, -3, -3],    
                   [-3, -3, 3, -3, -3, -3, -3],    
                   [-3, -3, 3, -3, -3, -3, -3]  // Row 0 (bottom)
                ] 
            },

            { // Ratings for board state practice 2
                board: [[0, 0, 1, 2, 1, 0, 0],[0, 0, 0, 2, 1, 0, 0],[0, 0, 0, 2, 1, 0, 0],[0, 0, 0, 1, 2, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                   [0, -3, 3, 2, 0, -3, 0],    
                   [0, -3, 3, 2, 0, -3, 0],    
                   [0, -3, 3, 2, 0, -3, 0],    
                   [0, -3, 3, 2, 0, -3, 0],    
                   [0, -3, 3, 2, 0, -3, 0],    
                   [0, -3, 3, 2, 0, -3, 0]  // Row 0 (bottom)
                ] 
            },

            // Experimental trials

            { // Ratings for board state 3
                board: [[0, 1, 2, 1, 2, 1, 2],[0, 1, 0, 0, 0, 2, 1],[0, 0, 0, 0, 0, 1, 0],[0, 0, 0, 0, 0, 2, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-3, -3, 2, 3, -2, -3, -3], 
                    [-3, -3, 2, 3, -2, -3, -3],  
                    [-3, -3, 2, 3, -2, -3, -3],  
                    [-3, -3, 2, 3, -2, -3, -3],  
                    [-3, -3, 2, 3, -2, -3, -3],  
                    [-3, -3, 2, 3, -2, -3, -3] // Row 0 (bottom) 
                ]
            },

            { // Ratings for board state 4
                board: [[2, 1, 2, 1, 0, 1, 2],[1, 0, 2, 0, 0, 1, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-2, 1, 2, 3, -3, 0, -3],  
                    [-2, 1, 2, 3, -3, 0, -3],  
                    [-2, 1, 2, 3, -3, 0, -3],  
                    [-2, 1, 2, 3, -3, 0, -3],  
                    [-2, 1, 2, 3, -3, 0, -3],  
                    [-2, 1, 2, 3, -3, 0, -3] // Row 0 (bottom)

                ] 
            },

            { // Ratings for board state 5
                board: [[2, 0, 0, 1, 2, 0, 1],[1, 0, 0, 2, 0, 0, 2],[1, 0, 0, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [1, -3, -3, 2, 3, -3, 2], 
                    [1, -3, -3, 2, 3, -3, 2],  
                    [1, -3, -3, 2, 3, -3, 2],  
                    [1, -3, -3, 2, 3, -3, 2],  
                    [1, -3, -3, 2, 3, -3, 2],  
                    [1, -3, -3, 2, 3, -3, 2] // Row 0 (bottom)

                ] 
            },

            { // Ratings for board state 6 
                board:  [[2, 2, 1, 2, 1, 2, 1],[2, 0, 1, 2, 0, 1, 1],[1, 0, 0, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 2],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-2, -3, 3, 2, -2, 2, -3],
                    [-2, -3, 3, 2, -2, 2, -3],  
                    [-2, -3, 3, 2, -2, 2, -3],  
                    [-2, -3, 3, 2, -2, 2, -3],  
                    [-2, -3, 3, 2, -2, 2, -3],  
                    [-2, -3, 3, 2, -2, 2, -3] // Row 0 (bottom)  
                   
                ] 
            },

            { // Ratings for board state 7
                board: [[2, 2, 1, 2, 0, 1, 1],[1, 1, 2, 0, 0, 1, 2],[0, 0, 2, 0, 0, 0, 2],[0, 0, 1, 0, 0, 0, 0],[0, 0, 1, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-3, 3, -2, 0, -2, 2, 3],  
                    [-3, 3, -2, 0, -2, 2, 3],  
                    [-3, 3, -2, 0, -2, 2, 3],  
                    [-3, 3, -2, 0, -2, 2, 3],  
                    [-3, 3, -2, 0, -2, 2, 3],  
                    [-3, 3, -2, 0, -2, 2, 3] // Row 0 (bottom)

                ] 
            },

            { // Ratings for board state 8  
                board: [[1, 2, 0, 2, 1, 1, 1],[2, 2, 0, 0, 2, 0, 0],[0, 1, 0, 0, 0, 0, 0],[0, 1, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-2, -2, -3, 3, 2, -2, -3],
                    [-2, -2, -3, 3, 2, -2, -3],
                    [-2, -2, -3, 3, 2, -2, -3],
                    [-2, -2, -3, 3, 2, -2, -3],
                    [-2, -2, -3, 3, 2, -2, -3],
                    [-2, -2, -3, 3, 2, -2, -3], // Row 0 (bottom)
                ] 
            },

            { // Ratings for board state 9  
                board: [[0, 0, 0, 1, 2, 1, 1],[0, 0, 0, 2, 2, 0, 1],[0, 0, 0, 0, 1, 0, 0],[0, 0, 0, 0, 2, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-3, -3, -3, 3, -3, 2, 2],
                    [-3, -3, -3, 3, -3, 2, 2],
                    [-3, -3, -3, 3, -3, 2, 2],
                    [-3, -3, -3, 3, -3, 2, 2],
                    [-3, -3, -3, 3, -3, 2, 2],
                    [-3, -3, -3, 3, -3, 2, 2], // Row 0 (bottom)
                ] 
            },

            { // Ratings for board state 10  
                board:[[1, 2, 1, 0, 1, 2, 0],[2, 0, 2, 0, 1, 0, 0],[1, 0, 1, 0, 0, 0, 0],[0, 0, 2, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]], 
                ratings: [
                    [2, 3, -3, 0, 2, 0, -3],  
                    [2, 3, -3, 0, 2, 0, -3],
                    [2, 3, -3, 0, 2, 0, -3],
                    [2, 3, -3, 0, 2, 0, -3],
                    [2, 3, -3, 0, 2, 0, -3],
                    [2, 3, -3, 0, 2, 0, -3],  // Row 0 (bottom)

                ] 
            },

            { // Ratings for board state 11 
                board: [[2, 1, 1, 1, 2, 2, 2],[2, 1, 1, 0, 2, 1, 1],[1, 2, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-3, -3, 2, 0, -3, 3, -3],
                    [-3, -3, 2, 0, -3, 3, -3],  
                    [-3, -3, 2, 0, -3, 3, -3],  
                    [-3, -3, 2, 0, -3, 3, -3],  
                    [-3, -3, 2, 0, -3, 3, -3],  
                    [-3, -3, 2, 0, -3, 3, -3]  // Row 0 (bottom) 
                ] 
            },

            { // Ratings for board state 12 
                board: [[0, 2, 1, 1, 1, 2, 0],[0, 1, 2, 2, 1, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-3, -3, 2, 3, 1, -2, -3],
                    [-3, -3, 2, 3, 1, -2, -3],  
                    [-3, -3, 2, 3, 1, -2, -3],  
                    [-3, -3, 2, 3, 1, -2, -3],  
                    [-3, -3, 2, 3, 1, -2, -3],  
                    [-3, -3, 2, 3, 1, -2, -3]  // Row 0 (bottom)  
                ] 
            },

            { // Ratings for board state 13  
                board: [[1, 2, 0, 2, 0, 1, 1],[0, 0, 0, 1, 0, 2, 2],[0, 0, 0, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 2],[0, 0, 0, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-3, 2, 2, 2, 2, 3, -3],
                    [-3, 2, 2, 2, 2, 3, -3],  
                    [-3, 2, 2, 2, 2, 3, -3],  
                    [-3, 2, 2, 2, 2, 3, -3],  
                    [-3, 2, 2, 2, 2, 3, -3],  
                    [-3, 2, 2, 2, 2, 3, -3]  // Row 0 (bottom)  
                ] 
            },

            { // Ratings for board state 14 
                board: [[2, 1, 1, 1, 2, 0, 0],[2, 0, 2, 1, 1, 0, 0],[0, 0, 1, 2, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [2, 0, 0, 3, 0, -3, -2],
                    [2, 0, 0, 3, 0, -3, -2],
                    [2, 0, 0, 3, 0, -3, -2],
                    [2, 0, 0, 3, 0, -3, -2],
                    [2, 0, 0, 3, 0, -3, -2],
                    [2, 0, 0, 3, 0, -3, -2],  // Row 0 (bottom)
                ] 
            },

            { // Ratings for board state 15 
                board: [[1, 1, 1, 2, 1, 2, 2],[0, 0, 0, 2, 1, 0, 2],[0, 0, 0, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-3, -2, -2, 2, 3, 0, -2],
                    [-3, -2, -2, 2, 3, 0, -2],
                    [-3, -2, -2, 2, 3, 0, -2],
                    [-3, -2, -2, 2, 3, 0, -2],
                    [-3, -2, -2, 2, 3, 0, -2],
                    [-3, -2, -2, 2, 3, 0, -2],  // Row 0 (bottom)
                ] 
            },

            { // Ratings for board state 16 
                board: [[1, 1, 2, 2, 1, 2, 2],[1, 0, 2, 1, 1, 1, 2],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-3, -1, 2, 2, 3, -2, 2],
                    [-3, -1, 2, 2, 3, -2, 2],
                    [-3, -1, 2, 2, 3, -2, 2],
                    [-3, -1, 2, 2, 3, -2, 2],
                    [-3, -1, 2, 2, 3, -2, 2],
                    [-3, -1, 2, 2, 3, -2, 2],  // Row 0 (bottom)  
                ] 
            },

            { // Ratings for board state 17 
                board: [[2, 2, 1, 1, 2, 1, 1],[0, 1, 1, 2, 2, 2, 1],[0, 0, 0, 0, 2, 0, 0],[0, 0, 0, 0, 1, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-2, -1, 3, 2, -2, -1, -3],
                    [-2, -1, 3, 2, -2, -1, -3],
                    [-2, -1, 3, 2, -2, -1, -3],
                    [-2, -1, 3, 2, -2, -1, -3],
                    [-2, -1, 3, 2, -2, -1, -3],
                    [-2, -1, 3, 2, -2, -1, -3],  // Row 0 (bottom)  
                    [-5, -1, 2, 1, -3, -1, -6],  
                ] 
            },

            { // Ratings for board state 18 
                board: [[2, 1, 1, 2, 1, 0, 1],[2, 0, 2, 0, 1, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [2, 3, 2, 3, 2, -3, -2],
                    [2, 3, 2, 3, 2, -3, -2],
                    [2, 3, 2, 3, 2, -3, -2],
                    [2, 3, 2, 3, 2, -3, -2],
                    [2, 3, 2, 3, 2, -3, -2],
                    [2, 3, 2, 3, 2, -3, -2],  // Row 0 (bottom)  
                ] 
            },

            { // Ratings for board state 19 
                board: [[1, 2, 0, 2, 1, 0, 0],[1, 1, 0, 0, 0, 0, 0],[0, 2, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [2, -2, -1, 3, -3, -3, -2],
                    [2, -2, -1, 3, -3, -3, -2],
                    [2, -2, -1, 3, -3, -3, -2],
                    [2, -2, -1, 3, -3, -3, -2],
                    [2, -2, -1, 3, -3, -3, -2],
                    [2, -2, -1, 3, -3, -3, -2],  // Row 0 (bottom)  
                ] 
            },

            { // Ratings for board state 20 
                board: [[2, 1, 1, 2, 1, 0, 1],[0, 2, 0, 0, 2, 0, 2],[0, 1, 0, 0, 1, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-2, 2, 2, 3, -2, -3, 2],
                    [-2, 2, 2, 3, -2, -3, 2],
                    [-2, 2, 2, 3, -2, -3, 2],
                    [-2, 2, 2, 3, -2, -3, 2],
                    [-2, 2, 2, 3, -2, -3, 2],
                    [-2, 2, 2, 3, -2, -3, 2],  // Row 0 (bottom)  
                ] 
            },

            { // Ratings for board state 21 
                board: [[0, 2, 1, 2, 1, 1, 0],[0, 1, 0, 2, 2, 1, 0],[0, 2, 0, 0, 0, 0, 0],[0, 1, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-3, -3, -2, 3, 1, 2, 0],
                    [-3, -3, -2, 3, 1, 2, 0],
                    [-3, -3, -2, 3, 1, 2, 0],
                    [-3, -3, -2, 3, 1, 2, 0],
                    [-3, -3, -2, 3, 1, 2, 0],
                    [-3, -3, -2, 3, 1, 2, 0],  // Row 0 (bottom)  
                ] 
            },

            { // Ratings for board state 22 
                board: [[1, 2, 1, 0, 2, 0, 0],[1, 2, 2, 0, 0, 0, 0],[1, 1, 0, 0, 0, 0, 0],[2, 1, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-3, -2, 2, -3, 3, -3, -3],
                    [-3, -2, 2, -3, 3, -3, -3],
                    [-3, -2, 2, -3, 3, -3, -3],
                    [-3, -2, 2, -3, 3, -3, -3],
                    [-3, -2, 2, -3, 3, -3, -3],
                    [-3, -2, 2, -3, 3, -3, -3],  // Row 0 (bottom) 
                ] 
            },

            { // Ratings for board state 23 
                board: [[2, 2, 1, 1, 2, 2, 1],[1, 2, 0, 0, 0, 0, 1],[0, 1, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-3, 0, -2, 2, 3, -2, -3],
                    [-3, 0, -2, 2, 3, -2, -3],
                    [-3, 0, -2, 2, 3, -2, -3],
                    [-3, 0, -2, 2, 3, -2, -3],
                    [-3, 0, -2, 2, 3, -2, -3],
                    [-3, 0, -2, 2, 3, -2, -3],  // Row 0 (bottom)  
                ] 
            },

            { // Ratings for board state 24 
                board: [[0, 2, 1, 1, 1, 2, 0],[0, 0, 1, 2, 0, 0, 0],[0, 0, 0, 2, 0, 0, 0],[0, 0, 0, 1, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-2, -1, 2, 0, 3, 0, -3],
                    [-2, -1, 2, 0, 3, 0, -3],
                    [-2, -1, 2, 0, 3, 0, -3],
                    [-2, -1, 2, 0, 3, 0, -3],
                    [-2, -1, 2, 0, 3, 0, -3],
                    [-2, -1, 2, 0, 3, 0, -3],  // Row 0 (bottom)
                ] 
            },

            { // Ratings for board state 25 
                board: [[1, 0, 1, 2, 1, 0, 1],[2, 0, 0, 2, 1, 0, 2],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [1, -3, -3, 3, 2, -2, 1],
                    [1, -3, -3, 3, 2, -2, 1],
                    [1, -3, -3, 3, 2, -2, 1],
                    [1, -3, -3, 3, 2, -2, 1],
                    [1, -3, -3, 3, 2, -2, 1],
                    [1, -3, -3, 3, 2, -2, 1],  // Row 0 (bottom)
                ] 
            },

            { // Ratings for board state 26 
                board: [[1, 2, 0, 2, 1, 2, 1],[2, 1, 0, 2, 1, 0, 1],[1, 0, 0, 0, 0, 0, 2],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-2, 2, -3, 3, -3, -2, -3],
                    [-2, 2, -3, 3, -3, -2, -3],
                    [-2, 2, -3, 3, -3, -2, -3],
                    [-2, 2, -3, 3, -3, -2, -3],
                    [-2, 2, -3, 3, -3, -2, -3],
                    [-2, 2, -3, 3, -3, -2, -3],  // Row 0 (bottom)  
                ] 
            },


            { // Ratings for board state 27 
                board: [[2, 1, 2, 0, 2, 1, 1],[1, 2, 0, 0, 1, 2, 1],[1, 0, 0, 0, 2, 0, 0],[2, 0, 0, 0, 0, 0, 0],[1, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-2, 2, 2, -3, 3, 0, -3],
                    [-2, 2, 2, -3, 3, 0, -3],
                    [-2, 2, 2, -3, 3, 0, -3],
                    [-2, 2, 2, -3, 3, 0, -3],
                    [-2, 2, 2, -3, 3, 0, -3],
                    [-2, 2, 2, -3, 3, 0, -3],  // Row 0 (bottom)  
                ] 
            },

            { // Ratings for board state 28 
                board: [[2, 1, 1, 2, 1, 0, 0],[0, 1, 2, 1, 1, 0, 0],[0, 1, 2, 2, 0, 0, 0],[0, 2, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [0, -2, 3, 2, 1, -3, -3],
                    [0, -2, 3, 2, 1, -3, -3],
                    [0, -2, 3, 2, 1, -3, -3],
                    [0, -2, 3, 2, 1, -3, -3],
                    [0, -2, 3, 2, 1, -3, -3],
                    [0, -2, 3, 2, 1, -3, -3],  // Row 0 (bottom)  
                ] 
            },

            { // Ratings for board state 29
                board: [[2, 0, 1, 1, 0, 2, 1],[1, 0, 2, 0, 0, 0, 1],[2, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-3, 2, 2, 3, -1, 2, -2],
                    [-3, 2, 2, 3, -1, 2, -2],
                    [-3, 2, 2, 3, -1, 2, -2],
                    [-3, 2, 2, 3, -1, 2, -2],
                    [-3, 2, 2, 3, -1, 2, -2],
                    [-3, 2, 2, 3, -1, 2, -2],  // Row 0 (bottom)  
                ] 
            },

            { // Ratings for board state 30
                board: [[1, 2, 2, 2, 1, 0, 1],[1, 1, 1, 2, 2, 0, 1],[2, 0, 0, 0, 1, 0, 2],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                    [-2, -1, 2, 3, -2, -3, -3],
                    [-2, -1, 2, 3, -2, -3, -3],
                    [-2, -1, 2, 3, -2, -3, -3],
                    [-2, -1, 2, 3, -2, -3, -3],
                    [-2, -1, 2, 3, -2, -3, -3],
                    [-2, -1, 2, 3, -2, -3, -3],  // Row 0 (bottom)  
                ] 
            },

            { // Ratings for board state 31 
                board: [[2, 1, 1, 2, 0, 2, 1],[1, 2, 2, 0, 0, 1, 2],[2, 0, 1, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 1],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]], 
                ratings: [
                    [2, 2, 3, 2, 0, -2, -3],
                    [2, 2, 3, 2, 0, -2, -3],
                    [2, 2, 3, 2, 0, -2, -3],
                    [2, 2, 3, 2, 0, -2, -3],
                    [2, 2, 3, 2, 0, -2, -3],
                    [2, 2, 3, 2, 0, -2, -3],  // Row 0 (bottom)  
                ] 
            },

            { // Ratings for board state 32  
                board: [[2, 1, 1, 2, 2, 1, 2],[1, 0, 0, 0, 1, 2, 2],[0, 0, 0, 0, 1, 0, 1],[0, 0, 0, 0, 2, 0, 1],[0, 0, 0, 0, 0, 0, 0],[0, 0, 0, 0, 0, 0, 0]],
                ratings: [
                     [-3, -2, -3, 2, -2, 3, -2],
                     [-3, -2, -3, 2, -2, 3, -2],
                     [-3, -2, -3, 2, -2, 3, -2],
                     [-3, -2, -3, 2, -2, 3, -2],
                     [-3, -2, -3, 2, -2, 3, -2],
                     [-3, -2, -3, 2, -2, 3, -2],  // Row 0 (bottom)
                       // Row 5
                ] 
            }
        ];

        const highlightedMoves = {
            1: { row: 3, col: 2 },  // Practice trial 1
            2: { row: 1, col: 2 },  // Practice trial 2
            3: { row: 1, col: 2 },  // trial 3
            4: { row: 1, col: 3 },  // trial 4
            5: { row: 1, col: 4 },  // trial 5
            6: { row: 2, col: 5 },  // trial 6
            7: { row: 2, col: 5 },  // trial 7
            8: { row: 1, col: 3 },  // trial 8
            9: { row: 2, col: 6 },  // trial 9
            10: { row: 3, col: 0 },  // trial 10
            11: { row: 2, col: 5 },  // trial 11
            12: { row: 2, col: 3 },  // trial 12
            13: { row: 1, col: 1 },  // trial 13
            14: { row: 3, col: 3 },  // trial 14
            15: { row: 2, col: 4 },  // trial 15
            16: { row: 2, col: 4 },  // trial 16
            17: { row: 2, col: 3 },  // trial 17
            18: { row: 2, col: 0 },  // trial 18
            19: { row: 1, col: 3 },  // trial 19
            20: { row: 2, col: 6 },  // trial 20
            21: { row: 2, col: 5 },  // trial 21
            22: { row: 2, col: 2 },  // trial 22


        }

        window.moveRatings = moveRatings;

        function isValidMove(col, boardState) {
            if (col < 0 || col >= 7) return null;  // Invalid column
    
            // Check if the column is full
            if (boardState[5][col] !== 0) return null;
    
            // Find the lowest empty position in the column
            for (let row = 0; row < 6; row++) {
                if (boardState[row][col] === 0 && (row === 0 || boardState[row - 1][col] !== 0)) {
                    return row;
                }
            }
            return null;
        }

        // Instructions phase
                
        function createBoard(boardState, shouldHighlight = false, highlightPos = null) {
            let boardHTML = '<div style="display: flex; flex-direction: column; align-items: center;">';
   
            // Title and board
            boardHTML += '<div style="font-size: 32px; font-weight: bold; margin-bottom: 20px;">Determine the optimal next move.</div>';
            boardHTML += '<div class="game-board">';
   
            // Game board cells
            for (let row = 5; row >= 0; row--) {
                for (let col = 0; col < 7; col++) {
                    let cellClass = 'cell';
                    let highlightStyle = '';
           
                if (shouldHighlight && highlightPos && highlightPos.row === row && highlightPos.col === col) {
                highlightStyle = 'box-shadow: 0 0 15px 5px #FFD700; border: 3px solid #FFD700; z-index: 10;';
                }
           
                if (boardState[row][col] === 0) {
                    cellClass += ' empty';
                } else if (boardState[row][col] === 1) {
                    cellClass += ' red';
                } else if (boardState[row][col] === 2) {
                    cellClass += ' yellow';
                }
           
                boardHTML += `<div class="${cellClass}" data-row="${row}" data-col="${col}" style="${highlightStyle}"></div>`;
            }
        }
    boardHTML += '</div>';

    // Suggestion notice below board
    if ((experimentCondition === 'algorithmic' || experimentCondition === 'human') && shouldHighlight) {
        const trialNumber = jsPsych.timelineVariable('trial_number');
        // Show only for practice trials (1-2) and first experimental trials (3-22)
        if (trialNumber >= 1 && trialNumber <= 22) {
            boardHTML += `<div style="color: #1A365D; font-size: 20px; margin: 20px 0; padding: 10px; background-color: #FAF9F6; border-radius: 7px; display: inline-flex; align-items: center; gap: 10px;">
                <div style="width: 20px; height: 20px; background-color: white; border-radius: 50%; border: 3px solid #EAB308;"></div>
                ${experimentCondition === 'algorithmic' ? "Algorithm's suggested move" : "Experienced player's suggested move"}
            </div>`;
        }
    }

    // Buttons
    boardHTML += '<div class="button-container">';
    boardHTML += '<button class="game-button undo-button" disabled>Undo Move</button>';
    boardHTML += '<button class="game-button submit-button" disabled>Submit Choice</button>';
    boardHTML += '</div></div>';

    return boardHTML;
}

const board_trial = {
    type: jsPsychHtmlButtonResponse,
    stimulus: function() {
        const condition = experimentCondition;
        const trialNumber = jsPsych.timelineVariable('trial_number');
        const boardState = jsPsych.timelineVariable('board');
        const shouldHighlight = ['algorithmic', 'human'].includes(condition);
        const highlightPos = highlightedMoves[trialNumber] || null;

        let progressHTML = '';
        if (trialNumber <= 2) {
            progressHTML = createProgressBar('Progress: Practice rounds', trialNumber, 2);
        } else {
            progressHTML = createProgressBar('Progress: Experimental rounds', trialNumber - 2, 30);
        }

        return progressHTML + createBoard(boardState, shouldHighlight, highlightPos);
    },
    choices: [],
    data: function() {
        return {
            trial_type: 'board-trial',
            trial_number: jsPsych.timelineVariable('trial_number'),
            condition: experimentCondition,
            initial_time: Date.now()
        };
    },
    on_load: function(trial) {
        let currentChoice = null;
        let moveStartTime = Date.now();
        const cells = document.querySelectorAll('.cell');
        const submitButton = document.querySelector('.submit-button');
        const undoButton = document.querySelector('.undo-button');
        const boardState = jsPsych.timelineVariable('board');
        
        let trialData = {
            trial_start: Date.now(),
            move_changes: [],
            total_changes: 0,
            response_times: [],
            inactivity_warnings: 0
        };

        function recordMove(row, col, event) {
            console.log('Recording move:', { row, col, event });
    
            // Validate coordinates
            if (row === null || col === null) {
                console.warn('Skipping move record - null coordinates');
                return;
            }
    
            // Validate bounds
            if (row < 0 || row >= 6 || col < 0 || col >= 7) {
                console.warn('Skipping move record - out of bounds:', row, col);
                return;
            }
    
            const currentTime = Date.now();
            const moveData = {
                row: row,
                col: col,
                time: currentTime,
                time_since_start: currentTime - trialData.trial_start,
                move_number: trialData.total_changes + 1
            };
    
            if (event) {
                moveData.mouse_position = {
                    x: event.clientX,
                    y: event.clientY
                };
            }
    
            console.log('Recording move data:', moveData);
            trialData.move_changes.push(moveData);
            trialData.total_changes++;
            trialData.response_times.push(currentTime - moveStartTime);
            moveStartTime = currentTime;
        }

        function updateButtons() {
            submitButton.disabled = currentChoice === null;
            undoButton.disabled = currentChoice === null;
        }

        function resetMove() {
            if (currentChoice !== null) {
                recordMove(null, null, null);
            }
            cells.forEach(c => {
                if (c.classList.contains('player-move')) {
                    c.classList.remove('yellow', 'player-move');
                    if (!c.classList.contains('red')) {
                        c.classList.add('empty');
                    }
                }
            });
            currentChoice = null;
            updateButtons();
        }

        let inactivityTimer = setTimeout(createInactivityMessage, 30000);

        cells.forEach(cell => {
            cell.addEventListener('click', function(event) {
                const col = parseInt(this.dataset.col);
                const validRow = isValidMove(col, boardState);
                
                if (validRow !== null) {
                    clearTimeout(inactivityTimer);
                    resetMove();
                    recordMove(validRow, col, event);
                    const targetCell = document.querySelector(
                        `.cell[data-row="${validRow}"][data-col="${col}"]`
                    );
                    targetCell.classList.remove('empty');
                    targetCell.classList.add('yellow', 'player-move');
                    currentChoice = {
                        row: validRow,
                        col: col
                    };
                    updateButtons();
                    inactivityTimer = setTimeout(createInactivityMessage, 30000);
                }
            });
        });

        undoButton.addEventListener('click', () => {
            resetMove();
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(createInactivityMessage, 30000);
        });

        submitButton.addEventListener('click', function() {
            if (currentChoice !== null) {
                clearTimeout(inactivityTimer);
                const finalData = {
                    choice_row: currentChoice.row,
                    choice_col: currentChoice.col,
                    trial_number: jsPsych.timelineVariable('trial_number'),
                    ...trialData
                };
                jsPsych.finishTrial(finalData);
            }
        });

        function createInactivityMessage() {
            trialData.inactivity_warnings++;
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 255, 255, 0.98);
                padding: 40px;
                border-radius: 15px;
                box-shadow: 0 0 30px rgba(0,0,0,0.3);
                font-size: 36px;
                z-index: 1000;
                border: 4px solid #E53E3E;
                text-align: center;
                min-width: 500px;
                color: #2D3748;
            `;
            message.innerHTML = `
                <div style="margin-bottom: 40px; font-weight: bold; color: #E53E3E;">
                    Attention!
                </div>
                <div style="margin-bottom: 40px;">
                    Hey, are you still there?<br>
                    Please make your move.
                </div>
                <button id="continueButton" style="
                    background-color: #E53E3E;
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 8px;
                    font-size: 24px;
                    cursor: pointer;
                    transition: background-color 0.3s;
                ">
                    Click to Continue
                </button>
            `;

            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 999;
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(message);

            const continueButton = message.querySelector('#continueButton');
            continueButton.addEventListener('mouseover', () => {
                continueButton.style.backgroundColor = '#C53030';
            });
            continueButton.addEventListener('mouseout', () => {
                continueButton.style.backgroundColor = '#E53E3E';
            });

            const removeMessage = () => {
                message.remove();
                overlay.remove();
                inactivityTimer = setTimeout(createInactivityMessage, 30000);
            };

            continueButton.addEventListener('click', removeMessage);
        }
    }
};
 
const confidence_rating = {
    type: jsPsychHtmlSliderResponse,
    stimulus: `
        <div style="width: 1000px; margin: 0 auto;">
            <div style="font-size: 40px; font-weight: bold; color: #2C5282; margin-bottom: 150px; line-height: 1.6;">
            How confident are you in your choice?
            </div>
        </div>`,
    labels: [ 
        '<div style="font-size: 28px; margin-bottom: 32px; line-height: 1.4;">Not confident at all</div>', 
        '<div style="font-size: 28px; margin-bottom: 32px; line-height: 1.4;">Very confident</div>'
    ],
    min: 0,
    max: 100,
    slider_start: undefined,
    step: 1,
    require_movement: true,
    button_label: 'Next >>',
    prompt: '<div style="margin-top: 100px;"></div>',
    data: {
        rating_type: 'confidence',
        adjustments: 0,
        initialRating: null
    },
    on_load: function() {
            const slider = document.querySelector('.jspsych-slider');
            let adjustments = 0;
            let initialRating = null;

            slider.addEventListener('mousedown', function() {
                if (initialRating === null) {
                    initialRating = slider.value;
                }
                adjustments++;
                slider.classList.add('clicked');
            });

            // Store these values where they can be accessed in on_finish
            this.adjustments = adjustments;
            this.initialRating = initialRating;
        },
        on_finish: function(data) {
            expectationCount++;
            data.adjustments = this.adjustments;
            data.initialRating = this.initialRating;
            DataCollector.recordRating(data.rating_type, data.response, data.rt, data.adjustments);
        }
    };
            

        const feedback_display = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                const allTrials = jsPsych.data.get().values();
            const lastBoardTrial = allTrials.filter(trial => 
                trial.hasOwnProperty('choice_row') && 
                trial.hasOwnProperty('choice_col')
            ).pop();

            if (!lastBoardTrial) return '<p>Error retrieving move data.</p>';

            const trialNumber = lastBoardTrial.trial_number;
            const row = lastBoardTrial.choice_row;
            const col = lastBoardTrial.choice_col;

            switch(experimentCondition) {
                case 'algorithmic':
                    return generateAlgorithmicFeedback(trialNumber, row, col);
                case 'human':
                    return generateHumanFeedback(trialNumber, row, col);
                default:
                    return generateControlFeedback(trialNumber, row, col);
            }
        },
        choices: ['Continue']
    };

        // Feedback generation functions for different conditions
        function generateControlFeedback(trialNumber, row, col) {
            const rating = moveRatings[trialNumber - 1].ratings[row][col];
            let feedbackHTML = '<div style="text-align: center;">';
            feedbackHTML += '<h2 style="font-size: 32px; margin-bottom: 60px">Feedback on your move</h2>';
            feedbackHTML += generateRatingVisualization(rating);
            feedbackHTML += '<div style="padding-bottom: 100px;"></div>';
            feedbackHTML += '</div>';

            return feedbackHTML;
        }

        function generateAlgorithmicFeedback(trialNumber, row, col) {
            return generateControlFeedback(trialNumber, row, col);
        }

        function generateHumanFeedback(trialNumber, row, col) {
            return generateControlFeedback(trialNumber, row, col);
        }


        // Helper function for rating visualization
        function generateRatingVisualization(rating) {
            let feedbackHTML = `<p style="font-size: 24px; transform: translateX(-6px); margin-bottom: 40px">Move rating: <strong>${rating}</strong></p>`;
            feedbackHTML += '<div style="width: 500px; height: 50px; background: linear-gradient(to right, red, white, green); margin: 20px auto; position: relative;">';
            const position = ((rating + 3) / 6) * 100;
            feedbackHTML += `<div style="position: absolute; left: ${position}%; transform: translateX(-50%); top: 0; width: 8px; font-weight: bold; font-family: Arial, sans-serif; padding-left: 6px; height: 100%; background: black;"></div>`;
            feedbackHTML += `<div style="position: absolute; left: ${position}%; transform: translateX(-50%); top: 120%; font-family: Arial, sans-serif; padding-left: 6px;">${rating}</div>`;
            feedbackHTML += '<div style="position: absolute; left: 0%; transform: translateX(-50%); top: 120%; font-family: Arial, sans-serif; padding-left: 6px;">-3</div>';
            feedbackHTML += '<div style="position: absolute; left: 50%; transform: translateX(-50%); top: 120%; font-family: Arial, sans-serif; padding-left: 6px;">0</div>';
            feedbackHTML += '<div style="position: absolute; left: 100%; transform: translateX(-50%); top: 120%; font-family: Arial, sans-serif; padding-left: 6px;">3</div>';
            feedbackHTML += '</div>';
            return feedbackHTML;
        }

        function createProgressBar(phase, current, total, className = '') {
            const percentage = (current / total) * 100;
            return `
                <div class="progress-container ${className}">
                    <div class="progress-label">${phase}</div>
                    <div class="progress-bar" style="width: ${percentage}%"></div>
                </div>`;
        }

        function collectTrialData(data) {
            return {
                ...data,
                trial_type: 'board-trial',
                condition: experimentCondition,
                rating: moveRatings[data.trial_number - 1].ratings[data.choice_row][data.choice_col],
                moveData: {
                    timestamp: Date.now(),
                    total_duration: Date.now() - data.trial_start,
                    move_history: data.move_changes,
                    total_moves: data.total_changes,
                    final_position: {
                        row: data.choice_row,
                        col: data.choice_col
                    },
                    inactivity_warnings: data.inactivity_warnings,
                    response_times: data.response_times
                }
            };
        }

        function collectManipulationCheckData(data) {
            return {
                response: data.response,
                is_correct: data.is_correct,
                response_time: data.rt,
                choice_made: data.choice_made,
                condition: data.condition,
                timestamp: Date.now()
            };
        }


        // Performance Expectations (Prospective)
        const expectation_rating = {
            type: jsPsychHtmlSliderResponse,
            stimulus: `
                <div style="width: 1000px; margin: 0 auto; margin-bottom: 60px">
                    <div style="font-size: 50px; margin-bottom: 20px; line-height: 1.4; color: #000000; background-color: #F7F7F7; padding: 20px; border-radius: 8px;">
                        Please answer the following question before continuing:
                </div>
                <div style="font-size: 40px; margin-bottom: 100px; font-weight: bold; line-height: 1.4; color: #276749; padding: 20px; border-radius: 8px;">
                    How well do you <span style="text-decoration: underline">expect to perform</span> in determining the optimal next move in the upcoming rounds?
                </div>
            </div>`,
        labels: [ 
            '<div style="font-size: 28px; margin-bottom: 32px; color: #276749;">Very poorly</div>', 
            '<div style="font-size: 28px; margin-bottom: 32px; color: #276749;">Very well</div>'
        ],
        min: 0,
        max: 100,
        slider_start: undefined,
        step: 1,
        slider_width: 800,
        require_movement: true,
        button_label: 'Next >>',
        prompt: '<div style="margin-top: 60px;"></div>',
        data: {
            rating_type: 'expectation',
            adjustments: 0,
            initialRating: null
        },
        on_load: function() {
            const slider = document.querySelector('.jspsych-slider');
            let adjustments = 0;
            let initialRating = null;

            slider.addEventListener('mousedown', function() {
                if (initialRating === null) {
                    initialRating = slider.value;
                }
                adjustments++;
                slider.classList.add('clicked');
            });

            // Store these values where they can be accessed in on_finish
            this.adjustments = adjustments;
            this.initialRating = initialRating;
        },
        on_finish: function(data) {
            expectationCount++;
            data.adjustments = this.adjustments;
            data.initialRating = this.initialRating;
            DataCollector.recordRating(data.rating_type, data.response, data.rt, data.adjustments);
        }
    };

        // Advice quality rating component
        const advice_quality_rating = {
            type: jsPsychHtmlSliderResponse,
            stimulus: `
            <div style="width: 1000px; margin: 0 auto; margin-bottom: 60px">
                <div style="font-size: 50px; margin-bottom: 20px; line-height: 1.4; color: #000000; background-color: #F7F7F7; padding: 20px; border-radius: 8px;">
                    Please answer the following question about the advice you received:
                </div>
                <div style="font-size: 40px; margin-bottom: 100px; font-weight: bold; line-height: 1.4; color: #276749; padding: 20px; border-radius: 8px;">
                    How would you rate the quality of the advice you received in the previous rounds?
                </div>
            </div>`,
        labels: [ 
            '<div style="font-size: 28px; margin-bottom: 32px; color: #744210;">Very poor quality</div>', 
            '<div style="font-size: 28px; margin-bottom: 32px; color: #744210;">Very high quality</div>'
        ],
        min: 0,
        max: 100,
        slider_start: undefined,
        step: 1,
        slider_width: 800,
        require_movement: true,
        button_label: 'Next >>',
        prompt: '<div style="margin-top: 60px;"></div>',
        data: {
            rating_type: 'advice_quality',
            adjustments: 0,
            initialRating: null
        },
        on_load: function() {
            const slider = document.querySelector('.jspsych-slider');
            let adjustments = 0;
            let initialRating = null;

            slider.addEventListener('mousedown', function() {
                if (initialRating === null) {
                    initialRating = slider.value;
                }
                adjustments++;
                slider.classList.add('clicked');
            });

            // Store these values where they can be accessed in on_finish
            this.adjustments = adjustments;
            this.initialRating = initialRating;
        },
        on_finish: function(data) {
            expectationCount++;
            data.adjustments = this.adjustments;
            data.initialRating = this.initialRating;
            DataCollector.recordRating(data.rating_type, data.response, data.rt, data.adjustments);
        }
    };

        // Notification about ending of advice
        const advice_end_notification = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="text-align: center;">
                    <div style="font-size: 40px; margin: auto; margin-bottom: 40px; width: 1000px; color: #2C5282; font-weight: bold;">
                        Important Notice
                    </div>
                    <div style="font-size: 32px; line-height: 1.6; margin-bottom: 40px color: #2D3748; background-color: #EDF2F7; padding: 30px; border-radius: 12px; margin: 0 auto; max-width: 800px;">
                        In the upcoming rounds, you will continue making decisions without any additional move advice.
                    </div>
                </div>`,
            choices: ['Continue'],
            conditional_function: function() {
                // Only show for algorithmic and human advice conditions
                return ['algorithmic', 'human'].includes(experimentCondition);
            }
        }

        // Performance Evaluation (Retrospective)
        const performance_rating = {
            type: jsPsychHtmlSliderResponse,
        stimulus: `
            <div style="font-size: 50px; margin: auto; width: 1000px; line-height: 1.4; color: #000000; background-color: #F7F7F7; padding: 20px; border-radius: 8px;">
                Please answer the following question before continuing:
            </div>
            <div style="font-size: 40px; margin-bottom: 100px; font-weight: bold; line-height: 1.4; color: #276749; padding: 20px; border-radius: 8px;">
                How well do you think you <span style="text-decoration: underline;">performed</span> in determining the optimal next move across the previous rounds?
            </div>`,
        labels: [ 
            '<div style="font-size: 28px; margin-bottom: 32px; color: #744210;">Very poorly</div>', 
            '<div style="font-size: 28px; margin-bottom: 32px; color: #744210;">Very well</div>'
        ],
        min: 0,
        max: 100,
        slider_start: undefined,
        step: 1,
        slider_width: 800,
        require_movement: true,
        button_label: 'Next >>',
        prompt: '<div style="margin-top: 60px;"></div>',
        data: {
            rating_type: 'performance',
            adjustments: 0,
            initialRating: null
        },

        on_load: function() {
            const slider = document.querySelector('.jspsych-slider');
            let adjustments = 0;
            let initialRating = null;

            slider.addEventListener('mousedown', function() {
                if (initialRating === null) {
                    initialRating = slider.value;
                }
                adjustments++;
                slider.classList.add('clicked');
            });

            // Store these values where they can be accessed in on_finish
            this.adjustments = adjustments;
            this.initialRating = initialRating;
        },
        on_finish: function(data) {
            expectationCount++;
            data.adjustments = this.adjustments;
            data.initialRating = this.initialRating;
            DataCollector.recordRating(data.rating_type, data.response, data.rt, data.adjustments);
        }
    };
        
    const final_next_button = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '<div style="font-size: 32px; text-align: center; margin-bottom: 30px;">You have completed the experiment.</div>',
    choices: ['Submit'],
    on_finish: function() {
        try {
            console.log('Starting final submission process...');
            
            // Get all trials data
            const trials = jsPsych.data.get().filter(trial => 
                trial.trial_type === 'board-trial'
            ).values();

            // Process each trial
            trials.forEach((trial, index) => {
                const trialNum = String(trial.trial_number).padStart(2, '0');
                
                try {
                    // Process trial data
                    const processedData = {
                        duration: trial.total_duration || 0,
                        moves: trial.total_changes || 0,
                        choice_col: trial.choice_col ?? -1,
                        response_time: trial.response_times ? 
                            trial.response_times[trial.response_times.length - 1] || 0 : 0,
                        confidence: trial.confidence_rating || 0,
                        warnings: trial.inactivity_warnings || 0
                    };

                    // Set values in form
                    document.getElementById(`ED01_${trialNum}`).value = processedData.duration;
                    document.getElementById(`ED02_${trialNum}`).value = processedData.moves;
                    document.getElementById(`ED03_${trialNum}`).value = processedData.choice_col;
                    document.getElementById(`ED04_${trialNum}`).value = processedData.response_time;
                    document.getElementById(`ED05_${trialNum}`).value = processedData.confidence;
                    document.getElementById(`ED07_${trialNum}`).value = processedData.warnings;

                    console.log(`Processed trial ${trialNum}:`, processedData);
                } catch (trialError) {
                    console.error(`Error processing trial ${trialNum}:`, trialError);
                }
            });

            // Process ratings data
            const ratings = jsPsych.data.get().filter(trial => 
                trial.rating_type !== undefined
            ).values();

            ratings.forEach((rating, index) => {
                try {
                    switch(rating.rating_type) {
                        case 'expectation':
                            document.getElementById(`ED08_${String(index + 1).padStart(2, '0')}`).value = rating.response || 0;
                            break;
                        case 'performance':
                            document.getElementById(`ED09_${String(index + 1).padStart(2, '0')}`).value = rating.response || 0;
                            break;
                        case 'advice_quality':
                            document.getElementById(`ED10_${String(index + 1).padStart(2, '0')}`).value = rating.response || 0;
                            break;
                    }
                } catch (ratingError) {
                    console.error(`Error processing rating ${index}:`, ratingError);
                }
            });

            // Set experiment-wide values
            document.getElementById('ED11_01').value = experimentCondition;
            document.getElementById('ED12_01').value = Date.now() - experimentStartTime;
            document.getElementById('ED14_01').value = JSON.stringify({
                userAgent: navigator.userAgent,
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                windowSize: `${window.innerWidth}x${window.innerHeight}`
            });

            // Submit form
            const form = document.getElementById('socisurvey_form');
            if (!form) {
                throw new Error('Form not found for submission');
            }

            console.log('Submitting form to SociSurvey...');
            form.submit();

        } catch (error) {
            console.error('Error in final submission:', error);
            alert('Error submitting data. Please contact the experimenter.');
        }
    }
};


        const trials = boardStates.map((boardState, index) => ({
            board: boardState,
            trial_number: index + 1
        }));
    
        // Initial message about practice trials
        const practiceIntro = {
            type: jsPsychHtmlButtonResponse,
            stimulus: '<p style="font-size: 40px">Practice Trials</p><p>You will now complete two practice rounds to familiarize yourself with the task.</p>',
            choices: ['Start Practice']
        };

        // First practice trial
        const firstPractice = {
            timeline: [board_trial, confidence_rating, feedback_display],
            timeline_variables: [trials[0]]  // First practice board state
        };

        // Message between practice trials
        const practiceBreak = {
            type: jsPsychHtmlButtonResponse,
            stimulus: '<p style="font-size: 40px">First Practice Complete</p><p>Let\'s try one more practice round.</p>',
            choices: ['Continue to Second Practice']
        };

        // Second practice trial
        const secondPractice = {
            timeline: [board_trial, confidence_rating, feedback_display],
            timeline_variables: [trials[1]]  // Second practice board state
        };

        // End of practice message
        const practiceEnd = {
            type: jsPsychHtmlButtonResponse,
            stimulus: '<p style="font-size: 40px">Practice Complete</p><p>You have completed both practice rounds. The main experiment will begin now.</p>',
            choices: ['Start Experiment']
        };

        // Split the experimental trials into segments
        const experimentalTrials1 = {
            timeline: [board_trial, confidence_rating, feedback_display],
            timeline_variables: trials.slice(2, 4)  // Trials 3-4
        };

        const experimentalTrials2 = {
            timeline: [board_trial, confidence_rating, feedback_display],
            timeline_variables: trials.slice(4, 22)  // Trials 3-23
        };

        const experimentalTrials3 = {
            timeline: [board_trial, confidence_rating, feedback_display],
            timeline_variables: trials.slice(22)  // Remaining trials
        };

        const adviceRelatedComponents = {
            timeline: [advice_quality_rating, advice_end_notification],
            conditional_function: function() {
                const shouldShow = ['algorithmic', 'human'].includes(experimentCondition);
                console.log('Checking advice components:', experimentCondition, shouldShow);
                return shouldShow;
            }
        };

        // Manipulation check for experimental groups
        const manipulation_check = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="width: 1000px; margin: 0 auto;">
                    <div style="font-size: 50px; margin-bottom: 20px; line-height: 1.4; color: #000000; background-color: #F7F7F7; padding: 20px; border-radius: 8px;">
                        Please answer the following question before continuing:
                    </div>
                    <div style="font-size: 40px; margin-bottom: 40px; font-weight: bold; line-height: 1.4; color: #2C5282;">
                        Where does the input for the provided decision support come from?
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                        <div class="choice-option" style="font-size: 24px; padding: 12px 20px; border: 2px solid #E2E8F0; border-radius: 8px; width: 90%; cursor: pointer;">
                            a) From an experienced player who scored higher than most participants.
                    </div>
                    <div class="choice-option" style="font-size: 24px; padding: 12px 20px; border: 2px solid #E2E8F0; border-radius: 8px; width: 90%; cursor: pointer;">
                        b) From an algorithm (a computer program that learns from examples) trained on Connect Four games.
                    </div>
                    <div class="choice-option" style="font-size: 24px; padding: 12px 20px; border: 2px solid #E2E8F0; border-radius: 8px; width: 90%; cursor: pointer;">
                        c) From a random number generator.
                    </div>
                    <div class="choice-option" style="font-size: 24px; padding: 12px 20px; border: 2px solid #E2E8F0; border-radius: 8px; width: 90%; cursor: pointer;">
                        d) From previous participants' most common moves.
                    </div>
                    <div class="choice-option" style="font-size: 24px; padding: 12px 20px; border: 2px solid #E2E8F0; border-radius: 8px; width: 90%; cursor: pointer;">
                        e) From a Connect Four tutorial website.
                    </div>
                </div>
            </div>`,
        choices: ['a', 'b', 'c', 'd', 'e'],
        button_html: `<button class="jspsych-btn" style="display: none;">%choice%</button>`,
        data: {
            task: 'manipulation_check',
            condition: function() { return experimentCondition; }
        },
        on_load: function() {
        document.querySelectorAll('.choice-option').forEach((choiceDiv, index) => {
            choiceDiv.addEventListener('click', () => {
                const buttons = document.querySelectorAll('.jspsych-html-button-response-button');
                if (buttons[index]) {
                    buttons[index].click();
                }
            });
            choiceDiv.addEventListener('mouseover', () => {
                choiceDiv.style.backgroundColor = '#EDF2F7';
            });
            choiceDiv.addEventListener('mouseout', () => {
                choiceDiv.style.backgroundColor = '';
            });
        });
    },
    on_finish: function(data) {
        const correctResponse = experimentCondition === 'human' ? 0 : 
                              experimentCondition === 'algorithmic' ? 1 : null;
        data.is_correct = data.response === correctResponse;
        const choiceOptions = [
            'experienced player',
            'algorithm',
            'random number generator',
            'previous participants',
            'tutorial website'
        ];
        data.choice_made = choiceOptions[data.response];
        data.correct_source = experimentCondition === 'human' ? choiceOptions[0] : choiceOptions[1];
        DataCollector.recordManipulationCheck(data);
    }
};
        

    // Feedback for manipulation check
    const manipulation_feedback = {
        type: jsPsychHtmlButtonResponse,
        stimulus: function() {
            const lastTrial = jsPsych.data.get().last(1).values()[0];
            const isCorrect = lastTrial.is_correct;
            const correctSource = experimentCondition === 'human' ? 
                'an experienced player who scored higher than most participants' : 
                'an algorithm - a computer program that learns from examples - trained on Connect Four games';

            if (isCorrect) {
                return `
                    <div style="width: 800px; margin: 0 auto; text-align: center;">
                        <div style="font-size: 36px; color: #276749; margin-bottom: 30px;">
                             Correct!
                        </div>
                        <div style="font-size: 24px; color: #2D3748;">
                            You correctly identified the source of your decision support.
                        </div>
                    </div>`;
            } else {
                return `
                    <div style="width: 800px; margin: 0 auto; text-align: center;">
                        <div style="font-size: 36px; color: #C53030; margin-bottom: 30px;">
                             Incorrect
                        </div>
                        <div style="font-size: 24px; color: #2D3748;">
                            Your decision support input actually comes from ${correctSource}.
                        </div>
                    </div>`;
            }
        },
        choices: ['Continue'],
        conditional_function: function() {
            return ['algorithmic', 'human'].includes(experimentCondition);
        }
    };

        // Define main timeline
        const timeline = [   
            instructions,
            practiceIntro,
            firstPractice,
            practiceBreak,
            secondPractice,
            practiceEnd,
            expectation_rating,  // First expectation rating
            manipulation_check,
            manipulation_feedback,
            experimentalTrials1,
            experimentalTrials2,
            performance_rating,  // First performance rating
            adviceRelatedComponents,  // Conditional advice components
            expectation_rating,  // Second expectation rating
            experimentalTrials3,
            performance_rating,   // Final performance rating
            final_next_button
        ];

        // Run the experiment
        jsPsych.run(timeline);
    </script>
</body>
</html></document_content>
